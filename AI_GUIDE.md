# Главное руководство для AI-агента

## 1. Цель

Эта инструкция предназначена для быстрой и эффективной интеграции AI-агента в проект `asyncmaxbot`. Твоя задача — не просто выполнять команды, а понимать архитектуру, следовать установленным процессам и обеспечивать высокое качество кода и документации. **Этот документ — твой единственный источник правды о процессах в проекте.**

## 2. Первый шаг: Полный анализ проекта (Обязательно)

Перед тем как вносить любые изменения или выполнять команды, ты должен построить полное представление о проекте.

### 2.1. Изучи исходный код

Прочитай и проанализируй все файлы в директории `maxbot/`. Это ядро библиотеки.
- `bot.py`: Основной класс `Bot`, методы взаимодействия с API.
- `dispatcher.py`: Механизм обработки обновлений, хендлеры.
- `max_types.py`: Pydantic-модели для всех объектов API.
- `filters.py`: Система фильтрации сообщений.
- `middleware.py`: Система промежуточных обработчиков.

### 2.2. Проанализируй документацию

Ознакомься со всей существующей документацией:
- `README.md`: Общее описание для пользователей.
- `ROADMAP.md`: Планы развития. Понимай, что "в планах", а что "реализовано".
- `CHANGELOG.md`: Список изменений в каждой версии.
- `docs/`: Исходники для сайта документации.

### 2.3. Изучи примеры и тесты

- `examples/`: Посмотри, как библиотека используется на практике.
- `tests/`: Проанализируй тесты, чтобы понять ожидаемое поведение функций.

**Результат этого этапа: у тебя есть полная ментальная модель проекта.**

## 3. Профессиональный Git-процесс (Git Flow)

Этот проект использует модель ветвления, основанную на Git Flow, для обеспечения стабильности и предсказуемости разработки.

### 3.1. Основные ветки:
- **`main`**: "Золотая" ветка. Здесь находится только стабильный, протестированный код, соответствующий последней **публичной** версии на PyPI. Прямые коммиты в `main` **запрещены**. Обновляется только через слияние релизных веток или хотфиксов.
- **`develop`**: Основная ветка для разработки. Она содержит все последние завершенные функции, которые войдут в следующий релиз. Является источником для создания релизных веток.

### 3.2. Вспомогательные ветки:
- **`feature/название-фичи`**: Ветки для разработки нового функционала.
  - Создаются из `develop`.
  - Вливаются обратно в `develop` через Pull Request (PR).
  - Пример: `feature/inline-keyboards`
- **`release/vX.Y.Z`**: Ветки для подготовки релиза.
  - Создаются из `develop`, когда решено, что `develop` готова к релизу.
  - В этой ветке происходит только исправление багов, обновление документации и версии. Новые фичи не добавляются.
  - После завершения вливается и в `main`, и в `develop`.
- **`hotfix/название-исправления`**: Ветки для срочного исправления багов в `main`.
  - Создаются из `main`.
  - После завершения вливаются и в `main`, и в `develop`.

## 4. Процесс разработки новой функции

1.  **Синхронизация:** Убедись, что твоя локальная ветка `develop` актуальна.
    ```bash
    git checkout develop
    git pull origin develop
    ```
2.  **Создание feature-ветки:** Создай новую ветку для своей задачи из `develop`. **Никаких коммитов напрямую в `main` или `develop`!**
    ```bash
    git checkout -b feature/название-твоей-фичи
    ```
3.  **Разработка и тестирование:**
    - Напиши код.
    - Напиши или обнови автотесты в директории `tests/`. **Это твоя ответственность.**
    - Запусти все тесты и убедись, что они проходят, и ты ничего не сломал: `python -m pytest tests/`.
4.  **Коммиты:** Делай атомарные коммиты с понятными сообщениями, следуя стандарту Conventional Commits.
    - `feat:` (новая функция), `fix:` (исправление бага), `docs:` (документация), `test:` (тесты), `chore:` (рутина).
    ```bash
    git add .
    git commit -m "feat: implement inline keyboards support"
    ```
5.  **Отправка на GitHub:** Запушь свою ветку в удаленный репозиторий.
    ```bash
    git push origin feature/название-твоей-фичи
    ```
6.  **Pull Request (PR):** Создай Pull Request из своей `feature/` ветки в `develop`.
7.  **Сквош коммитов (Squash):** Если в твоей `feature`-ветке много "рабочих" коммитов (`fix typo`, `oops`), их нужно объединить (squash) в один перед созданием Pull Request'а для чистоты истории. Это делается через `git rebase -i`.

## 5. Детальный процесс создания релиза (STEP-BY-STEP)

### 5.1. Подготовка к релизу

1. **Проверь готовность `develop`:**
   ```bash
   git checkout develop
   git pull origin develop
   python -m pytest tests/  # Убедись, что все тесты проходят
   ```

2. **Создай release-ветку:**
   ```bash
   git checkout -b release/vX.Y.Z develop
   ```

### 5.2. Обновление версии и документации

3. **Обнови версию в `pyproject.toml`:**
   - Найди строку `version = "X.Y.Z"` и увеличь версию согласно семантическому версионированию
   - `X.Y.Z` → `X.Y.Z+1` для patch (баги)
   - `X.Y.Z` → `X.Y+1.0` для minor (новые функции)
   - `X.Y.Z` → `X+1.0.0` для major (breaking changes)

4. **Обнови `CHANGELOG.md`:**
   - Добавь новую секцию `## [X.Y.Z] - YYYY-MM-DD`
   - Перемести все изменения из "Unreleased" в эту секцию
   - Сгруппируй изменения по категориям: `### Добавлено`, `### Изменено`, `### Исправлено`, `### Удалено`

5. **Проверь и обнови документацию:**
   - Убедись, что `README.md` актуален
   - Проверь примеры в `examples/`
   - Обнови `ROADMAP.md` если нужно

### 5.3. Финальное тестирование

6. **Запусти полное тестирование:**
   ```bash
   python -m pytest tests/ -v
   python -m build  # Проверь, что пакет собирается
   ```

7. **Проверь документацию:**
   ```bash
   mkdocs build  # Собери сайт документации
   mkdocs serve  # Запусти локально для проверки
   ```

### 5.4. Завершение релиза

8. **Сделай финальный коммит:**
   ```bash
   git add .
   git commit -m "chore: prepare release vX.Y.Z"
   ```

9. **Слей в `main`:**
   ```bash
   git checkout main
   git merge --no-ff release/vX.Y.Z
   git tag -a vX.Y.Z -m "Release vX.Y.Z"
   ```

10. **Слей обратно в `develop`:**
    ```bash
    git checkout develop
    git merge --no-ff release/vX.Y.Z
    ```

11. **Удали release-ветку:**
    ```bash
    git branch -d release/vX.Y.Z
    ```

### 5.5. Публикация на PyPI

12. **Отправь изменения на GitHub:**
    ```bash
    git push origin main
    git push origin develop
    git push --tags
    ```

13. **Собери пакет:**
    ```bash
    python -m build
    ```

14. **Опубликуй на PyPI:**
    ```bash
    twine upload dist/*
    ```
    **Примечание:** Если возникает ошибка аутентификации, используй токен напрямую:
    ```bash
    twine upload --username __token__ --password pypi-TOKEN dist/*
    ```

### 5.6. Обновление документации

15. **Обнови сайт документации:**
    ```bash
    mkdocs gh-deploy
    ```

### 5.7. Создание GitHub Release

16. **Создай GitHub Release:**
    ```bash
    gh release create vX.Y.Z --generate-notes
    ```

### 5.8. Финальная проверка

17. **Проверь результат:**
    - Убедись, что пакет появился на PyPI: https://pypi.org/project/asyncmaxbot/
    - Проверь, что документация обновилась: https://sdkinfotech.github.io/asyncmaxbot/
    - Проверь GitHub Release: https://github.com/sdkinfotech/asyncmaxbot/releases

## 6. Принцип "Проверяй, а не доверяй"

- **Проверяй вывод команд:** Если команда сообщила об ошибке, проанализируй ее. Если сообщила об успехе, убедись, что результат действительно корректен.
- **Кодировка:** Всегда используй `UTF-8`.
- **Пути к файлам:** Перепроверяй пути, особенно в Windows.

---
*Эта инструкция — закон. Следуй ей, чтобы поддерживать порядок в репозитории.* 